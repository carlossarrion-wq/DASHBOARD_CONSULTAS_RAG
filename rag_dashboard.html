<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Query Monitoring Dashboard</title>
    
    <!-- AWS Amazon Ember Font -->
    <link rel="preconnect" href="https://d1tzzh0q3mh5bp.cloudfront.net">
    <link href="https://d1tzzh0q3mh5bp.cloudfront.net/fonts/amazon-ember/amazon-ember.css" rel="stylesheet">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-status disconnected">
        üî¥ Disconnected from Data Source
    </div>

    <div class="header">
        <h1>RAG Query Monitoring Dashboard</h1>
        <p>Real-time monitoring and analysis of RAG system queries</p>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('user-requests-tab')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                    User Requests
                </button>
                <button class="tab-button" onclick="showTab('team-requests-tab')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    Team Requests
                </button>
                <button class="tab-button" onclick="showTab('requests-details-tab')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                    </svg>
                    Requests Details
                </button>
                <button class="tab-button" onclick="showTab('trust-details-tab')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                    </svg>
                    Trust Details
                </button>
                <button class="tab-button" onclick="showTab('requests-history-tab')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Requests History
                </button>
            </div>
            
            <!-- User Requests Tab -->
            <div id="user-requests-tab" class="tab-content active">
                <div class="section-header">
                    <h2>User Requests</h2>
                    <button class="refresh-button" onclick="loadDashboardData()" title="Refresh Data">
                        <span class="refresh-icon">&#x21bb;</span>
                        Refresh
                    </button>
                </div>
                
                <!-- Top Row: Quadrant Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- Top-Left Quadrant: 4 Key Metrics (2x2 grid) -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="metric-card">
                            <h3>Total Queries</h3>
                            <div class="metric-value" id="user-total-queries-today">-</div>
                            <div class="metric-change positive" id="user-queries-change">
                                <span>‚Üó</span> Loading...
                            </div>
                            <div class="metric-subtitle">Today</div>
                        </div>
                        
                        <div class="metric-card">
                            <h3>Active Users</h3>
                            <div class="metric-value" id="user-active-users">-</div>
                            <div class="metric-change positive" id="user-users-change">
                                <span>‚Üó</span> Loading...
                            </div>
                            <div class="metric-subtitle">Today</div>
                        </div>
                        
                        <div class="metric-card">
                            <h3>Avg Queries/User</h3>
                            <div class="metric-value" id="user-avg-queries">-</div>
                            <div class="metric-change" id="user-avg-change">
                                <span>-</span> Loading...
                            </div>
                            <div class="metric-subtitle">Active users today</div>
                        </div>
                        
                        <div class="metric-card">
                            <h3>Avg Response Time</h3>
                            <div class="metric-value" id="user-avg-response-time">-</div>
                            <div class="metric-change" id="user-response-change">
                                <span>-</span> Loading...
                            </div>
                            <div class="metric-subtitle">Seconds</div>
                        </div>
                    </div>
                    
                    <!-- Top-Right Quadrant: Hourly Usage Histogram -->
                    <div class="card">
                        <h2>Hourly Query Volume Today</h2>
                        <div style="height: 300px; position: relative;">
                            <canvas id="hourly-histogram-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Row: Alerts and User Histogram -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- Bottom-Left: Alerts -->
                    <div class="card">
                        <h2>User Query Alerts</h2>
                        <div id="user-alerts-container">
                            <div class="alert info">
                                <div class="loading-spinner"></div>
                                <strong>Connecting:</strong> Establishing connection to data source...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom-Right: Histogram per User -->
                    <div class="card">
                        <h2>Query Distribution by User Today</h2>
                        <div style="height: 300px; position: relative;">
                            <canvas id="user-distribution-histogram"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px; position: relative;">
                    <h2>User Query Details</h2>
                    <button class="export-button" onclick="exportUserQueryTable()" title="Export to CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Export
                    </button>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-controls">
                        <div class="pagination-info">
                            <span id="user-query-info">Showing 0-0 of 0 users</span>
                        </div>
                        <div class="pagination-buttons">
                            <button id="prev-user-query-btn" class="btn" onclick="loadPreviousUserQueryPage()" disabled>
                                ‚Üê
                            </button>
                            <span id="user-query-page-info">Page 1</span>
                            <button id="next-user-query-btn" class="btn" onclick="loadNextUserQueryPage()" disabled>
                                ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <table id="user-query-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Name</th>
                                <th>Team</th>
                                <th>Daily Queries</th>
                                <th>Daily Limit</th>
                                <th>Daily Usage</th>
                                <th>Monthly Queries</th>
                                <th>Monthly Limit</th>
                                <th>Monthly Usage</th>
                                <th>Avg Response Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="10">
                                    <div class="loading-spinner"></div>
                                    Loading user data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="dashboard" style="margin-top: 20px;">
                    <div class="card">
                        <h2>User Daily Queries</h2>
                        <div class="chart-container">
                            <canvas id="user-daily-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Model Usage Distribution</h2>
                        <div class="chart-container">
                            <canvas id="model-usage-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Team Requests Tab -->
            <div id="team-requests-tab" class="tab-content">
                <div class="section-header">
                    <h2>Team Requests</h2>
                    <button class="refresh-button" onclick="loadDashboardData()" title="Refresh Data">
                        <span class="refresh-icon">&#x21bb;</span>
                        Refresh
                    </button>
                </div>
                
                <div class="dashboard">
                    <div class="card">
                        <h2>Team Query Alerts</h2>
                        <div id="team-alerts-container">
                            <div class="alert info">
                                <div class="loading-spinner"></div>
                                <strong>Loading:</strong> Fetching team data...
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Team Monthly Queries</h2>
                        <div class="chart-container">
                            <canvas id="team-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard" style="margin-top: 20px;">
                    <div class="card" style="position: relative;">
                        <h2>Team Query Details</h2>
                        <button class="export-button" onclick="exportTeamQueryTable()" title="Export to CSV">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            Export
                        </button>
                        <table id="team-query-table">
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>Daily Queries</th>
                                    <th>Daily Usage</th>
                                    <th>Monthly Queries</th>
                                    <th>Monthly Usage</th>
                                    <th>Avg Response Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6">
                                        <div class="loading-spinner"></div>
                                        Loading team data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="card" style="position: relative;">
                        <h2>Users in Team</h2>
                        <button class="export-button" onclick="exportTeamUsersTable()" title="Export to CSV">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            Export
                        </button>
                        
                        <!-- Pagination Controls -->
                        <div class="pagination-controls">
                            <div class="pagination-info">
                                <span id="team-users-info">Showing 0-0 of 0 users</span>
                            </div>
                            <div class="pagination-buttons">
                                <button id="prev-team-users-btn" class="btn" onclick="loadPreviousTeamUsersPage()" disabled>
                                    ‚Üê
                                </button>
                                <span id="team-users-page-info">Page 1</span>
                                <button id="next-team-users-btn" class="btn" onclick="loadNextTeamUsersPage()" disabled>
                                    ‚Üí
                                </button>
                            </div>
                        </div>
                        
                        <table id="team-users-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Name</th>
                                    <th>Team</th>
                                    <th>Monthly Queries</th>
                                    <th>% of Team Usage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5">
                                        <div class="loading-spinner"></div>
                                        Loading team users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard" style="margin-top: 20px;">
                    <div class="card">
                        <h2>Team Daily Queries</h2>
                        <div class="chart-container">
                            <canvas id="team-daily-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Requests Details Tab -->
            <div id="requests-details-tab" class="tab-content">
                <div class="section-header">
                    <h2>Requests Details</h2>
                    <button class="refresh-button" onclick="refreshRequestsDetails()" title="Refresh Data">
                        <span class="refresh-icon">&#x21bb;</span>
                        Refresh
                    </button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h2>Daily Query Trend - Last 10 Days</h2>
                    <div class="chart-container">
                        <canvas id="requests-details-chart"></canvas>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px; position: relative;">
                    <h2>User Queries - Last 10 Days</h2>
                    <button class="export-button" onclick="exportRequestsDetailsTable()" title="Export to CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Export
                    </button>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-controls">
                        <div class="pagination-info">
                            <span id="requests-details-info">Showing 0-0 of 0 users</span>
                        </div>
                        <div class="pagination-buttons">
                            <button id="prev-requests-details-btn" class="btn" onclick="loadPreviousRequestsDetailsPage()" disabled>
                                ‚Üê
                            </button>
                            <span id="requests-details-page-info">Page 1</span>
                            <button id="next-requests-details-btn" class="btn" onclick="loadNextRequestsDetailsPage()" disabled>
                                ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <table id="requests-details-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Name</th>
                                <th>Team</th>
                                <th id="day-9">Day -9</th>
                                <th id="day-8">Day -8</th>
                                <th id="day-7">Day -7</th>
                                <th id="day-6">Day -6</th>
                                <th id="day-5">Day -5</th>
                                <th id="day-4">Day -4</th>
                                <th id="day-3">Day -3</th>
                                <th id="day-2">Day -2</th>
                                <th id="day-1">Day -1</th>
                                <th id="day-0">Today</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="13">
                                    <div class="loading-spinner"></div>
                                    Loading requests details...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card" style="margin-top: 20px; position: relative;">
                    <h2>Model Usage by Team - Last 10 Days</h2>
                    <button class="export-button" onclick="exportModelUsageTable()" title="Export to CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Export
                    </button>
                    <table id="model-usage-table">
                        <thead>
                            <tr>
                                <th>MODEL</th>
                                <th>Engineering</th>
                                <th>Data Science</th>
                                <th>Product</th>
                                <th>Research</th>
                                <th>Operations</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7">
                                    <div class="loading-spinner"></div>
                                    Loading model usage data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 20px;">
                    <div class="card">
                        <h2>Model Consumption Evolution - Last 10 Days</h2>
                        <div class="chart-container">
                            <canvas id="model-consumption-evolution-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Response Time Evolution - Last 10 Days</h2>
                        <div class="chart-container">
                            <canvas id="response-time-evolution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trust Details Tab -->
            <div id="trust-details-tab" class="tab-content">
                <div class="section-header">
                    <h2>Trust Details</h2>
                    <button class="refresh-button" onclick="refreshTrustDetails()" title="Refresh Data">
                        <span class="refresh-icon">&#x21bb;</span>
                        Refresh
                    </button>
                </div>
                
                <!-- Trust Indicators -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="metric-card trust-metric">
                        <h3>Average Trust Today</h3>
                        <div class="metric-value" id="trust-avg-today">-</div>
                        <div class="metric-change">
                            <span>‚Üí</span> Daily average
                        </div>
                        <div class="metric-subtitle">Today</div>
                    </div>
                    
                    <div class="metric-card trust-metric">
                        <h3>80th Percentile Trust Today</h3>
                        <div class="metric-value" id="trust-p80-today">-</div>
                        <div class="metric-change">
                            <span>‚Üí</span> 80% of queries
                        </div>
                        <div class="metric-subtitle">Today</div>
                    </div>
                    
                    <div class="metric-card trust-metric">
                        <h3>Ratio of "High" responses Today</h3>
                        <div class="metric-value" id="trust-high-rate-today">-</div>
                        <div class="metric-change">
                            <span>‚Üí</span> >70% trust
                        </div>
                        <div class="metric-subtitle">Today</div>
                    </div>
                    
                    <div class="metric-card trust-metric">
                        <h3>Average Trust Last 7 Days</h3>
                        <div class="metric-value" id="trust-avg-7days">-</div>
                        <div class="metric-change">
                            <span>‚Üí</span> Weekly average
                        </div>
                        <div class="metric-subtitle">Last 7 days</div>
                    </div>
                    
                    <div class="metric-card trust-metric">
                        <h3>80th Percentile Trust Last 7 Days</h3>
                        <div class="metric-value" id="trust-p80-7days">-</div>
                        <div class="metric-change">
                            <span>‚Üí</span> 80% of queries
                        </div>
                        <div class="metric-subtitle">Last 7 days</div>
                    </div>
                    
                    <div class="metric-card trust-metric">
                        <h3>Ratio of "High" responses Last 7 days</h3>
                        <div class="metric-value" id="trust-high-rate-7days">-</div>
                        <div class="metric-change">
                            <span>‚Üí</span> >70% trust
                        </div>
                        <div class="metric-subtitle">Last 7 days</div>
                    </div>
                </div>
                
                <!-- Trust by Team and Day Table - Full Width -->
                <div class="card" style="margin-bottom: 2rem; position: relative;">
                    <h2>Trust by Team and Day - Last 7 Days</h2>
                    <button class="export-button" onclick="exportTrustByTeamTable()" title="Export to CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Export
                    </button>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-controls">
                        <div class="pagination-info">
                            <span id="trust-by-team-info">Showing 0-0 of 0 records</span>
                        </div>
                        <div class="pagination-buttons">
                            <button id="prev-trust-by-team-btn" class="btn" onclick="loadPreviousTrustByTeamPage()" disabled>
                                ‚Üê
                            </button>
                            <span id="trust-by-team-page-info">Page 1</span>
                            <button id="next-trust-by-team-btn" class="btn" onclick="loadNextTrustByTeamPage()" disabled>
                                ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <table id="trust-by-team-table">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th id="trust-day-6">Day -6</th>
                                <th id="trust-day-5">Day -5</th>
                                <th id="trust-day-4">Day -4</th>
                                <th id="trust-day-3">Day -3</th>
                                <th id="trust-day-2">Day -2</th>
                                <th id="trust-day-1">Day -1</th>
                                <th id="trust-day-0">TODAY</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8">
                                    <div class="loading-spinner"></div>
                                    Loading trust data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Trust by Typology Table -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h2>
                        Trust by Typology - Last 7 Days
                        <span class="info-tooltip" title="Trust percentage is extracted from the llm_trust field which contains a value between 0-100 indicating the model's confidence in its response">üõà</span>
                    </h2>
                    <table id="trust-by-typology-table">
                        <thead>
                            <tr>
                                <th>Typology</th>
                                <th>Avg Trust</th>
                                <th>Queries</th>
                                <th>Min</th>
                                <th>Max</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5">
                                    <div class="loading-spinner"></div>
                                    Loading typology data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="card">
                        <h2>Trust Distribution by Ranges</h2>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="trust-distribution-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Trust Evolution by Team</h2>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="trust-evolution-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Trust Levels Evolution (7 Days)</h2>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="trust-levels-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Requests History Tab -->
            <div id="requests-history-tab" class="tab-content">
                <div class="section-header">
                    <h2>Requests History</h2>
                    <button class="refresh-button" onclick="refreshRequestsHistory()" title="Refresh Data">
                        <span class="refresh-icon">&#x21bb;</span>
                        Refresh
                    </button>
                </div>
                
                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="filter-search">Search</label>
                            <input type="text" id="filter-search" placeholder="Search in queries or session ID...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-person">Person</label>
                            <select id="filter-person">
                                <option value="">All</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-team">Team</label>
                            <select id="filter-team">
                                <option value="">All</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-model">Model</label>
                            <select id="filter-model">
                                <option value="">All</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-status">Status</label>
                            <select id="filter-status">
                                <option value="">All</option>
                                <option value="completed">completed</option>
                                <option value="error">error</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-start-date">Start Date</label>
                            <input type="date" id="filter-start-date">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-end-date">End Date</label>
                            <input type="date" id="filter-end-date">
                        </div>
                    </div>
                    
                    <div class="filter-buttons">
                        <button class="clear-btn" onclick="clearFilters()">Clear Filters</button>
                        <button class="apply-btn" onclick="applyFilters()">Apply Filters</button>
                    </div>
                </div>
                
                <!-- Query Logs Table -->
                <div class="card" style="margin-top: 20px; position: relative;">
                    <h2>Query Logs</h2>
                    <button class="export-button" onclick="exportQueryLogsTable()" title="Export to CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Export
                    </button>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-controls">
                        <div class="pagination-info">
                            <span id="query-logs-info">Showing 0-0 of 0 logs</span>
                        </div>
                        <div class="pagination-buttons">
                            <button id="prev-query-logs-btn" class="btn" onclick="loadPreviousQueryLogsPage()" disabled>
                                ‚Üê
                            </button>
                            <span id="query-logs-page-info">Page 1</span>
                            <button id="next-query-logs-btn" class="btn" onclick="loadNextQueryLogsPage()" disabled>
                                ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <table id="query-logs-table">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th>DATE</th>
                                <th>SESSION ID</th>
                                <th>PERSON</th>
                                <th>TEAM</th>
                                <th>QUERY</th>
                                <th>STATUS</th>
                                <th>TOKENS</th>
                                <th>TIME</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7">
                                    <div class="loading-spinner"></div>
                                    Loading query logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Query Details -->
    <div id="query-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Query Details</h2>
                <button class="modal-close" onclick="closeQueryDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Basic Information Section -->
                <div class="modal-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                        </svg>
                        Basic Information
                    </h3>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-label">ID:</span>
                            <span class="modal-value" id="modal-id">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Session Token:</span>
                            <span class="modal-value" id="modal-session-token">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Conversation ID Bedrock:</span>
                            <span class="modal-value" id="modal-conversation-id-bedrock">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Team:</span>
                            <span class="modal-value" id="modal-app-name">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Status:</span>
                            <span class="modal-value" id="modal-status">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Streaming Status:</span>
                            <span class="modal-value" id="modal-streaming-status">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Created At:</span>
                            <span class="modal-value" id="modal-created-at">-</span>
                        </div>
                    </div>
                </div>

                <!-- User Information Section -->
                <div class="modal-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                        User Information
                    </h3>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-label">User ID:</span>
                            <span class="modal-value" id="modal-user-id">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">User Name:</span>
                            <span class="modal-value" id="modal-user-name">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Person Name:</span>
                            <span class="modal-value" id="modal-person-name">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">IAM Group:</span>
                            <span class="modal-value" id="modal-iam-group">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Query and Response Section -->
                <div class="modal-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                        </svg>
                        User Query
                    </h3>
                    <div class="modal-query-box" id="modal-user-query">-</div>
                    
                    <h3 class="modal-section-title" style="margin-top: 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                        </svg>
                        LLM Response
                    </h3>
                    <div class="modal-conversation-box" id="modal-llm-response">-</div>
                </div>

                <!-- Tokens Section -->
                <div class="modal-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                        </svg>
                        Tokens
                    </h3>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-label">Tokens Input:</span>
                            <span class="modal-value" id="modal-tokens-input">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Tokens Output:</span>
                            <span class="modal-value" id="modal-tokens-output">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Tokens Total:</span>
                            <span class="modal-value" id="modal-tokens-total">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Retrieved Docs Count:</span>
                            <span class="modal-value" id="modal-retrieved-docs-count">-</span>
                        </div>
                    </div>
                </div>

                <!-- Trust & Confidence Section -->
                <div class="modal-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                        </svg>
                        Trust & Confidence
                    </h3>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-label">Confidence Score:</span>
                            <span class="modal-value" id="modal-confidence-score">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">LLM Trust Category:</span>
                            <span class="modal-value" id="modal-llm-trust-category">-</span>
                        </div>
                    </div>
                </div>

                <!-- Tool Results Section (JSONB) -->
                <div class="modal-section" id="modal-tool-results-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                        </svg>
                        Tool Results
                    </h3>
                    <div id="modal-tool-results-container">
                        <p class="modal-empty-state">No tool results available</p>
                    </div>
                </div>
                
                <!-- Performance Metrics Section -->
                <div class="modal-section">
                    <h3 class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                        </svg>
                        Performance Metrics
                    </h3>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-label">Response Time (ms):</span>
                            <span class="modal-value" id="modal-response-time-ms">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Response Timestamp:</span>
                            <span class="modal-value" id="modal-response-timestamp">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Strategy Analysis Section -->
                <div class="modal-section" id="modal-strategy-section" style="display: none;">
                    <h3 class="modal-section-title">Strategy Analysis</h3>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-label">Strategy Type:</span>
                            <span class="modal-value" id="modal-strategy-type">-</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-label">Strategy Confidence:</span>
                            <span class="modal-value">
                                <span id="modal-strategy-confidence">-</span>
                                <div class="progress-bar" style="margin-top: 5px;">
                                    <div class="progress-fill" id="modal-strategy-confidence-bar" style="width: 0%"></div>
                                </div>
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- LLM Trust Score Section -->
                <div class="modal-section" id="modal-trust-section" style="display: none;">
                    <h3 class="modal-section-title">LLM Trust Score</h3>
                    <div class="modal-trust-score">
                        <div class="trust-score-header">
                            <span class="trust-score-value" id="modal-trust-score">-</span>
                            <span class="trust-score-badge" id="modal-trust-badge">-</span>
                        </div>
                        <div class="progress-bar trust-progress">
                            <div class="progress-fill" id="modal-trust-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="trust-explanation" id="modal-trust-explanation">-</div>
                    </div>
                </div>
                
                <!-- Detected Intentions Section -->
                <div class="modal-section" id="modal-intentions-section" style="display: none;">
                    <h3 class="modal-section-title">Detected Intentions</h3>
                    <div class="modal-list" id="modal-intentions-list">
                        <p class="modal-empty-state">No intentions detected</p>
                    </div>
                </div>
                
                <!-- Tools Used Section -->
                <div class="modal-section" id="modal-tools-section" style="display: none;">
                    <h3 class="modal-section-title">Tools Used</h3>
                    <div class="modal-list" id="modal-tools-list">
                        <p class="modal-empty-state">No tools used</p>
                    </div>
                </div>
                
                <!-- Retrieved Documents Section -->
                <div class="modal-section" id="modal-documents-section" style="display: none;">
                    <h3 class="modal-section-title">Retrieved Documents</h3>
                    <div class="modal-documents-container">
                        <table class="modal-documents-table" id="modal-documents-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Source</th>
                                    <th>Similarity</th>
                                    <th>Citation Confidence</th>
                                    <th>Document Reference</th>
                                </tr>
                            </thead>
                            <tbody id="modal-documents-tbody">
                                <tr>
                                    <td colspan="5" class="modal-empty-state">No documents retrieved</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Error Section -->
                <div class="modal-section" id="modal-error-section" style="display: none;">
                    <h3 class="modal-section-title" style="color: #c53030;">Error</h3>
                    <div class="modal-error-box" id="modal-error-message">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/aws-sdk@2.1048.0/dist/aws-sdk.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/dashboard.js"></script>
    
    <script>
        // Session validation - runs before anything else
        (function() {
            'use strict';
            
            console.log('üîê Checking authentication...');
            
            // Require authentication before loading dashboard
            if (!window.authModule || !window.authModule.isAuthenticated()) {
                console.warn('‚ö†Ô∏è No valid session found - redirecting to login');
                window.location.href = 'login.html?error=no_credentials';
                return;
            }
            
            console.log('‚úÖ Session validated');
            
            // Configure AWS SDK with stored credentials
            const configured = window.authModule.configureAWS();
            if (!configured) {
                console.error('‚ùå Failed to configure AWS SDK');
                window.location.href = 'login.html?error=invalid_session';
                return;
            }
            
            // Display user info in console
            const user = window.authModule.getCurrentUser();
            if (user) {
                console.log('üë§ Logged in as:', user.arn);
                const timeRemaining = window.authModule.getSessionTimeRemaining();
                if (timeRemaining !== null) {
                    console.log('‚è±Ô∏è Session time remaining:', timeRemaining, 'minutes');
                }
            }
            
            // Set up session timeout warning
            const timeRemaining = window.authModule.getSessionTimeRemaining();
            if (timeRemaining !== null && timeRemaining < 10) {
                console.warn('‚ö†Ô∏è Session will expire in', timeRemaining, 'minutes');
            }
            
            // Check session periodically (every 5 minutes)
            setInterval(function() {
                if (!window.authModule.isAuthenticated()) {
                    console.warn('‚ö†Ô∏è Session expired - redirecting to login');
                    alert('Your session has expired. Please login again.');
                    window.authModule.logout('login.html');
                }
                
                const remaining = window.authModule.getSessionTimeRemaining();
                if (remaining !== null && remaining <= 5 && remaining > 0) {
                    console.warn('‚ö†Ô∏è Session expiring soon:', remaining, 'minutes remaining');
                }
            }, 5 * 60 * 1000); // Check every 5 minutes
            
        })();
    </script>
    
    <script>
        // Utility function to generate percentage indicators
        function createPercentageIndicator(percentage, includeText = true) {
            const numericValue = typeof percentage === 'string' ? 
                parseFloat(percentage.replace('%', '')) : percentage;
            
            let cssClass = 'percentage-indicator ';
            
            if (numericValue === 0) {
                cssClass += 'zero';
            } else if (numericValue === 100) {
                cssClass += 'full';
            } else if (numericValue > 0 && numericValue <= 25) {
                cssClass += 'low';
            } else if (numericValue > 25 && numericValue <= 50) {
                cssClass += 'medium-low';
            } else if (numericValue > 50 && numericValue <= 75) {
                cssClass += 'medium';
            } else if (numericValue > 75 && numericValue <= 90) {
                cssClass += 'high';
            } else if (numericValue > 90) {
                cssClass += 'critical';
            }
            
            return `<span class="${cssClass}" data-percentage="${numericValue}%" title="Usage: ${numericValue}%" style="--fill-width: ${numericValue}%"></span>`;
        }
        
        window.createPercentageIndicator = createPercentageIndicator;
    </script>
</body>
</html>
